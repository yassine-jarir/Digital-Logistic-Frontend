<div class="create-container">
  <div class="create-header">
    <h1>Create Sales Order</h1>
  </div>

  <div class="error-message" *ngIf="error">
    {{ error }}
  </div>

  <form (ngSubmit)="onSubmit()" class="order-form">
    <div class="info-message" *ngIf="warehousesLoading">Loading warehouses...</div>
    <div class="error-message" *ngIf="warehousesError">{{ warehousesError }}</div>

    <div class="form-group">
      <label for="warehouse">Warehouse <span class="required">*</span></label>
      <select id="warehouse" name="warehouse" [(ngModel)]="warehouseId" [disabled]="loading || warehousesLoading" required>
        <option [ngValue]="null" disabled>Select a warehouse</option>
        <option *ngFor="let w of warehouses" [ngValue]="w.id">{{ w.name }}</option>
      </select>
    </div>

    <div class="form-group">
      <label for="clientId">Client ID <span class="required">*</span></label>
      <input
        type="number"
        id="clientId"
        name="clientId"
        [(ngModel)]="clientId"
        min="1"
        required
      />
      <small class="hint">Temporary: required by backend. If unknown, ask admin for your numeric client ID.</small>
    </div>
    <div class="info-message" *ngIf="productsLoading">
      Loading products...
    </div>

    <div class="error-message" *ngIf="productsError">
      {{ productsError }}
      <button type="button" class="btn btn-secondary btn-sm" (click)="loadProducts()" [disabled]="productsLoading">
        Retry
      </button>
    </div>

    <div class="form-group">
      <label for="orderDate">Order Date <span class="required">*</span></label>
      <input
        type="date"
        id="orderDate"
        name="orderDate"
        [(ngModel)]="order.orderDate"
        required
      />
    </div>

    <div class="items-header">
      <h2>Items</h2>
      <button type="button" class="btn btn-secondary" (click)="addItem()" [disabled]="loading">
        + Add Item
      </button>
    </div>

    <div class="item-card" *ngFor="let item of order.items; let i = index; trackBy: trackByIndex">
      <div class="item-row">
        <div class="form-group">
          <label>Product <span class="required">*</span></label>
          <select
            name="productId-{{ i }}"
            [(ngModel)]="item.productId"
            (ngModelChange)="onProductSelected(item)"
            [disabled]="loading || productsLoading"
            required
          >
            <option [ngValue]="0" disabled>Select a product</option>
            <option *ngFor="let p of products" [ngValue]="p.id">
              {{ formatProductOption(p) }}
            </option>
          </select>
        </div>

        <div class="form-group">
          <label>Quantity <span class="required">*</span></label>
          <input
            type="number"
            name="quantity-{{ i }}"
            [(ngModel)]="item.quantity"
            min="1"
            required
          />
        </div>

        <div class="form-group">
          <label>Unit Price</label>
          <input
            type="number"
            name="unitPrice-{{ i }}"
            [(ngModel)]="item.unitPrice"
            min="0"
            step="0.01"
          />
        </div>

        <div class="item-actions">
          <button
            type="button"
            class="btn btn-danger"
            (click)="removeItem(i)"
            [disabled]="loading || order.items.length <= 1"
            title="Remove item"
          >
            Remove
          </button>
        </div>
      </div>
    </div>

    <div class="form-actions">
      <button type="button" class="btn btn-secondary" (click)="cancel()" [disabled]="loading">
        Cancel
      </button>
      <button type="submit" class="btn btn-primary" [disabled]="loading">
        {{ loading ? 'Creating...' : 'Create Order' }}
      </button>
    </div>
  </form>
</div>
